---
# yamllint disable rule:line-length
name: Android build

on:
  push:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - 'manual/**'
    tags:
      - '*'
  pull_request:
    branches:
      - main
      - master
    paths-ignore:
      - 'manual/**'

env:
  BUILD_TYPE: Release
  CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Android arm64-v8a
            arch: arm64-v8a
            toolchain: android-aarch64-toolchain.cmake
            push_cloudsmith: 1

          - name: Android armeabi-v7a
            arch: armeabi-v7a
            toolchain: android-armhf-toolchain.cmake
            push_cloudsmith: 1

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext ninja-build

      - name: Download wxWidgets for Android
        run: |
          # Download pre-built wxWidgets for Android from OpenCPN
          wget -q https://dl.cloudsmith.io/public/nohal/opencpn-plugins/raw/files/wxWidgets-android-${{ matrix.arch }}.tar.xz \
            -O /tmp/wxWidgets-android.tar.xz || echo "wxWidgets download failed - may need manual setup"
          if [ -f /tmp/wxWidgets-android.tar.xz ]; then
            sudo mkdir -p /opt/wxWidgets-android
            sudo tar -xJf /tmp/wxWidgets-android.tar.xz -C /opt/wxWidgets-android
          fi

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.ANDROID_NDK }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.arch }} \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_CXX_STANDARD=17

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target tarball

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.arch }}-tarball
          path: |
            build/*.tar.gz
            build/*.xml

      - name: Upload to Cloudsmith
        if: matrix.push_cloudsmith == 1 && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          pip install cloudsmith-cli
          cd build
          ../ci/upload.sh
